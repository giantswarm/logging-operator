# This file was generated by logging-operator.
# It configures the Grafana-agent to be used as events logger.
# - configMap is generated from events-logger.grafanaagent.template and passed as a string
#   here and will be created by Grafana-agent's chart.
# - Grafana-agent runs as a deployment, with only 1 replica.
grafana-agent:
  agent:
    configMap:
      content: |-
        logging {
        	level  = "info"
        	format = "logfmt"
        }
        
        remote.kubernetes.secret "credentials" {
        	namespace = "kube-system"
        	name = "exclude-namespaces-grafana-agent-secret"
        }
        
        loki.source.kubernetes_events "local" {
        	namespaces = []
        	forward_to = [loki.process.default.receiver]
        }
        // exclude configured namespaces
        loki.process "default" {
        	forward_to = [loki.write.default.receiver]
        
        	stage.drop {
        		source = "namespace"
        		expression = "namespace1|namespace2"
        	}
        }
        
        loki.write "default" {
        	endpoint {
        		url                = nonsensitive(remote.kubernetes.secret.credentials.data["logging-url"])
        		tenant_id          = nonsensitive(remote.kubernetes.secret.credentials.data["logging-tenant-id"])
        
        		basic_auth {
        			username = nonsensitive(remote.kubernetes.secret.credentials.data["logging-username"])
        			password = remote.kubernetes.secret.credentials.data["logging-password"]
        		}
        
        		tls_config {
        			insecure_skip_verify = false
        		}
        	}
        	external_labels = {
        		installation = "test-installation",
        		cluster_id = "exclude-namespaces",
        		scrape_job = "kubernetes-events",
        	}
        }
        
    extraArgs:
    - --disable-reporting
  controller:
    replicas: 1
    type: deployment
  crds:
    create: false
