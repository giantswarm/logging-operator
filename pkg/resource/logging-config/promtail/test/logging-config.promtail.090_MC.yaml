# This file was generated by logging-operator.
# It configures Promtail to be used as a logging agent.
# - Promtail runs as a daemonset, with required tolerations in order to scrape logs
#   from every machine in the cluster.
# - Running as root user is required in order to be able to read log files within
#   /var/log/journal and /run/log/journal directories.
# - NODENAME env var is used as additional label for kubernetes_audit logs.
promtail:
  config:
    snippets:
      addScrapeJobLabel: true
      extraRelabelConfigs:
        - source_labels: ['node_name']
          target_label: 'node'
        - regex: 'node_name'
          action: labeldrop
      extraScrapeConfigs: |
        # this one includes also system logs reported by systemd-journald
        - job_name: systemd_journal_run
          journal:
            path: /run/log/journal
            max_age: 12h
            json: true
            labels:
              scrape_job: system-logs
          relabel_configs:
          - source_labels: ['__journal__systemd_unit']
            target_label: '__tmp_systemd_unit'
          - source_labels:
            - __journal__systemd_unit
            - __journal_syslog_identifier
            separator: ;
            regex: ';(.+)'
            replacement: $1
            target_label: '__tmp_systemd_unit'
          - source_labels: ['__tmp_systemd_unit']
            target_label: 'systemd_unit'
          - source_labels: ['__journal__hostname']
            target_label: 'node'
          pipeline_stages:
          - json:
              expressions:
                SYSLOG_IDENTIFIER: SYSLOG_IDENTIFIER
          - drop:
              source: SYSLOG_IDENTIFIER
              value: audit
        - job_name: systemd_journal_var
          journal:
            path: /var/log/journal
            max_age: 12h
            json: true
            labels:
              scrape_job: system-logs
          relabel_configs:
          - source_labels: ['__journal__systemd_unit']
            target_label: '__tmp_systemd_unit'
          - source_labels:
            - __journal__systemd_unit
            - __journal_syslog_identifier
            separator: ;
            regex: ';(.+)'
            replacement: $1
            target_label: '__tmp_systemd_unit'
          - source_labels: ['__tmp_systemd_unit']
            target_label: 'systemd_unit'
          - source_labels: ['__journal__hostname']
            target_label: 'node'
          pipeline_stages:
          - json:
              expressions:
                SYSLOG_IDENTIFIER: SYSLOG_IDENTIFIER
          - drop:
              source: SYSLOG_IDENTIFIER
              value: audit
        - job_name: kubernetes-audit
          static_configs:
          - targets:
            - localhost
            labels:
              scrape_job: audit-logs
              __path__: /var/log/apiserver/audit.log
              node: ${NODENAME:-unknown}
          pipeline_stages:
          - json:
              expressions:
                objectRef: objectRef
          - json:
              expressions:
                resource: resource
                namespace: namespace
              source: objectRef
          - labels:
              namespace:
              filename:
  extraArgs:
  - -log-config-reverse-order
  - -config.expand-env=true
  extraEnv:
  - name: NODENAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
  extraVolumeMounts:
  - mountPath: /run/log/journal/
    name: journal-run
    readOnly: true
  - mountPath: /var/log/journal/
    name: journal-var
    readOnly: true
  - mountPath: /var/log/apiserver/
    name: apiserver-logs
    readOnly: true
  extraVolumes:
  - hostPath:
      path: /run/log/journal/
    name: journal-run
  - hostPath:
      path: /var/log/journal/
    name: journal-var
  - hostPath:
      path: /var/log/apiserver/
    name: apiserver-logs
